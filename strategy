// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/

//@version=5
strategy("False breakout strategy", overlay=true, initial_capital=100, calc_on_every_tick=false)

// Импортируем минимальные цены биткоина на часовых барах
btc_price = request.security("ETHUSDT", "60", low)

window = 20

// Минимальные цены по 20 часовым барам
lowest_low = ta.lowest(btc_price, window)

// Минимальные цены по 20 барам, не включающих последний (текущий) бар
lowest_low1 = ta.lowest(btc_price[1], window-1)

// ATR
atr = request.security("ETHUSDT", "D", ta.atr(14))

// Чтобы принтить TP
take_profit = high * 1.001

longCondition = (low < lowest_low1) and (strategy.opentrades == 0) and close < lowest_low1 * 0.999

// Входим в лонг, если выполняется условие
if longCondition
    take_profit := lowest_low1 + atr * 1
    stop_loss = low * (1 - 0.)

    strategy.cancel_all()
    
    // Заходим на всю котлету
    currentBalance = strategy.initial_capital + strategy.netprofit
    balanceInContracts = currentBalance/close

    name = str.format("long:{0}", bar_index)
    //name = str.format("long:{0}", long_counter)
    //name = "long"

    // Здесь stop= означает что когда цена вырастет до уровня lowest_low1 входим в лонг (типа stop buy)
    strategy.entry(name, strategy.long, qty=balanceInContracts, stop=lowest_low1)
    strategy.exit("exit", name, stop=stop_loss, limit=take_profit)

if true
    candlesToEntrytInput = 20
    if nz(ta.barssince(longCondition)) == candlesToEntrytInput and strategy.position_size == 0
        //name = str.format("long:{0}", long_counter)
        //name = "long"
        //strategy.cancel(name)
        strategy.cancel_all()


plot(strategy.opentrades + 2000, color=color.orange)
//plot_stop_loss = strategy.position_avg_price * (1 - 0.005)
//plot_take_profit = strategy.position_avg_price  * (1 + 0.01)

plot(lowest_low1)
//plot(atr)
plot(take_profit, color=color.green)
